(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(a){if(a.ep)return;a.ep=!0;const o=s(a);fetch(a.href,o)}})();function f(){const t=document.getElementById("theme-toggle");(localStorage.getItem("felix-ai-theme")||"light")==="dark"&&(document.body.classList.add("dark-mode"),t.checked=!0),t.addEventListener("change",()=>{t.checked?(document.body.classList.add("dark-mode"),localStorage.setItem("felix-ai-theme","dark")):(document.body.classList.remove("dark-mode"),localStorage.setItem("felix-ai-theme","light"))});const s=document.querySelectorAll(".tab-button"),n=document.querySelectorAll(".tab-content");s.forEach(a=>{a.addEventListener("click",()=>{s.forEach(o=>o.classList.remove("active")),a.classList.add("active"),n.forEach(o=>{o.id===a.dataset.tab?o.classList.add("active"):o.classList.remove("active")})})})}function l(t,e){const s=document.getElementById("chat-window"),n=document.createElement("div");n.classList.add("message",`${t}-message`);let a;t==="ai"?a=`<span class="material-symbols-outlined avatar">smart_toy</span>
                       <div class="message-content">${marked.parse(e)}</div>`:a=`<div class="message-content">${e.replace(/</g,"<").replace(/>/g,">")}</div>`,n.innerHTML=a,s.appendChild(n),t==="ai"&&g(n),s.scrollTop=s.scrollHeight}function g(t){t.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e);const s=e.parentElement;if(s.querySelector(".copy-button"))return;const n=document.createElement("button");n.className="copy-button",n.innerText="Kopiuj",n.onclick=()=>{navigator.clipboard.writeText(e.textContent).then(()=>{n.innerText="Skopiowano!",setTimeout(()=>{n.innerText="Kopiuj"},2e3)})},s.appendChild(n)})}function m(t){document.getElementById("typing-indicator").classList.toggle("hidden",!t)}function d(t){const e=document.getElementById("analysis-results");e.innerHTML=t}function h(){document.getElementById("analysis-results").innerHTML=""}const w="gemma-3-27b-it",k="TUTAJ_WKLEJ_SWÓJ_KLUCZ_API_Z_GOOGLE_AI_STUDIO",E=`https://generativelanguage.googleapis.com/v1beta/models/${w}:generateContent?key=${k}`;function z(){return[{role:"user",parts:[{text:`Jesteś 'Felix-AI', ekspertem od Microsoft Excel. Twoje zadania:
    1.  Generuj i tłumacz formuły Excela (używaj polskich nazw funkcji jak SUMA, JEŻELI).
    2.  Analizuj dane (do 100 komórek) i twórz podsumowania.
    3.  Sugeruj typy wykresów. Użyj specjalnego formatu: [ACTION:CREATE_CHART:TypWykresu], gdzie TypWykresu to jeden z: ColumnClustered, Line, Pie, XYScatter.
    4.  Tłumacz nagłówki.
    5.  Formatuj formuły i kod w blokach markdown. Odpowiadaj profesjonalnie i zwięźle.`}]},{role:"model",parts:[{text:"Rozumiem. Jestem Felix-AI, gotowy do pomocy w Excelu."}]}]}async function y(t,e,s=""){let n=t;const a=await p();a&&(n=`Kontekst z zaznaczonych komórek Excela (w formacie JSON): ${JSON.stringify(a)}. Polecenie użytkownika: "${t}"`),s&&(n=`Kontekst z zaznaczonych komórek: ${JSON.stringify(a)}. Specjalne zadanie: ${s}`);const o=[...e,{role:"user",parts:[{text:n}]}],r=await T(o),i=I(r);return i?(await A(i.type,i.payload),`Wykonałem akcję: ${i.type} z parametrem ${i.payload}.`):r}async function T(t){const s=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:t})});if(!s.ok){const a=await s.json();throw new Error(a.error?.message||"Błąd serwera API.")}return(await s.json()).candidates?.[0]?.content?.parts?.[0]?.text||"Brak odpowiedzi."}function I(t){const e=t.match(/\[ACTION:(\w+):(.+?)\]/);return e?{type:e[1],payload:e[2]}:null}async function A(t,e){t==="CREATE_CHART"&&await v(e)}async function p(){try{return await Excel.run(async t=>{const e=t.workbook.getSelectedRange();return e.load(["values","cellCount"]),await t.sync(),e.cellCount>100?(console.warn("Zaznaczono więcej niż 100 komórek."),null):e.values})}catch(t){return console.error("Błąd pobierania danych z Excela:",t),null}}async function v(t){await Excel.run(async e=>{const s=e.workbook.getSelectedRange();e.workbook.worksheets.getActiveWorksheet().charts.add(t,s,"Auto"),await e.sync()})}Office.onReady(async t=>{if(t.host===Office.HostType.Excel){f();let e=JSON.parse(localStorage.getItem("felix-ai-history"))||z();document.getElementById("chat-window").innerHTML="",e.slice(1).forEach(r=>l(r.role==="user"?"user":"ai",r.parts[0].text));const s=document.getElementById("chat-form"),n=document.getElementById("prompt-input"),a=document.getElementById("send-button");s.addEventListener("submit",async r=>{r.preventDefault();const i=n.value.trim();if(i){a.disabled=!0,n.value="",l("user",i),e.push({role:"user",parts:[{text:i}]}),m(!0);try{const c=await y(i,e);l("ai",c),e.push({role:"model",parts:[{text:c}]}),localStorage.setItem("felix-ai-history",JSON.stringify(e))}catch(c){l("ai",`Wystąpił błąd: ${c.message}`)}finally{m(!1),a.disabled=!1}}});const o=(r,i)=>{document.getElementById(r).addEventListener("click",async()=>{if(h(),!await p()){d("<p>Proszę zaznaczyć dane w arkuszu (maks. 100 komórek).</p>");return}d("<p>Analizuję dane...</p>");try{const u=await y("",e,i);d(marked.parse(u))}catch(u){d(`<p>Błąd: ${u.message}</p>`)}})};o("analyze-data-btn","Wygeneruj zwięzłe podsumowanie dla tych danych."),o("suggest-chart-btn","Zaproponuj najlepszy typ wykresu dla tych danych i odpowiedz tylko akcją [ACTION:CREATE_CHART:TypWykresu]."),o("translate-headers-btn","Przetłumacz nagłówki (pierwszy wiersz danych) na język angielski. Zwróć tylko przetłumaczone słowa oddzielone przecinkami.")}});
