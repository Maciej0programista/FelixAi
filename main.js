(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();Office.onReady(async e=>{if(e.host!==Office.HostType.Excel){console.error("Aplikacja jest przeznaczona tylko dla programu Excel.");return}C()});const A="gemini-1.5-flash-latest",h="AIzaSyDdiiErxw-D8FRxk0VN38NkSAZkmj6iWgU",j=`https://generativelanguage.googleapis.com/v1beta/models/${A}:generateContent?key=${h}`,p=200;let l=[];function C(){x(),L(),w(),d("ai","Witaj! Jestem Felix-AI w wersji 2.0. Jak mogę Ci dzisiaj pomóc w Excelu?")}function x(){const e=document.getElementById("theme-toggle");(localStorage.getItem("felix-ai-theme")||"light")==="dark"&&(document.body.classList.add("dark-mode"),e.checked=!0),e.addEventListener("change",()=>{document.body.classList.toggle("dark-mode",e.checked),localStorage.setItem("felix-ai-theme",e.checked?"dark":"light")});const o=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");o.forEach(r=>{r.addEventListener("click",()=>{o.forEach(s=>s.classList.remove("active")),r.classList.add("active");const c=r.dataset.tab;t.forEach(s=>{s.classList.toggle("active",s.id===c)})})});const n=document.getElementById("chat-form");n.addEventListener("submit",S);const i=document.getElementById("prompt-input");i.addEventListener("input",()=>{i.style.height="auto",i.style.height=`${i.scrollHeight}px`}),i.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),n.requestSubmit())}),document.querySelectorAll(".action-button").forEach(r=>{r.addEventListener("click",T)}),document.getElementById("clear-history-btn").addEventListener("click",O),document.getElementById("export-history-btn").addEventListener("click",R)}function w(){const e=document.getElementById("chat-window");e.innerHTML="",l.slice(2).forEach(a=>{d(a.role==="model"?"ai":"user",a.parts[0].text,!0)})}function d(e,a,o=!1){const t=document.getElementById("chat-window"),n=document.createElement("div");n.classList.add("message",`${e}-message`),o&&(n.style.animation="none");const i=document.createElement("div");if(i.classList.add("message-content"),e==="ai"){const s=document.createElement("span");s.className="material-symbols-outlined avatar",s.textContent="smart_toy",n.appendChild(s)}const{cleanText:r,action:c}=E(a);if(i.innerHTML=marked.parse(r||"..."),c&&c.type==="INSERT_FORMULA"){const s=document.createElement("div");s.className="message-actions";const u=document.createElement("button");u.className="message-action-btn",u.textContent="Wstaw Formułę",u.onclick=()=>z(c.type,c.payload),s.appendChild(u),i.appendChild(s)}n.appendChild(i),t.appendChild(n),e==="ai"&&g(n),t.scrollTop=t.scrollHeight}function g(e){e.querySelectorAll("pre code").forEach(a=>{hljs.highlightElement(a);const o=a.parentElement;if(o.querySelector(".copy-button"))return;const t=document.createElement("button");t.className="copy-button",t.textContent="Kopiuj",t.onclick=()=>{navigator.clipboard.writeText(a.textContent).then(()=>{t.textContent="Skopiowano!",setTimeout(()=>{t.textContent="Kopiuj"},2e3)})},o.appendChild(t)})}function y(e){document.getElementById("typing-indicator").classList.toggle("hidden",!e),document.getElementById("chat-window").scrollTop=document.getElementById("chat-window").scrollHeight}function m(e){const a=document.getElementById("analysis-results");a.innerHTML=e,g(a)}function k(){return[{role:"user",parts:[{text:`Jesteś 'Felix-AI v2.0', światowej klasy ekspertem od Microsoft Excel zintegrowanym z arkuszem. Twoje zadania:
1.  **Formuły**: Generuj i tłumacz formuły Excela. Używaj polskich nazw funkcji (np. SUMA, JEŻELI, WYSZUKAJ.PIONOWO). Jeśli generujesz formułę, dodaj na końcu akcję [ACTION:INSERT_FORMULA:twoja_formula_tutaj].
2.  **Analiza Danych**: Analizuj dane (do 200 komórek) i twórz zwięzłe podsumowania w formacie markdown.
3.  **Wykresy**: Sugeruj typy wykresów. Odpowiadaj **tylko i wyłącznie** akcją w formacie [ACTION:CREATE_CHART:TypWykresu]. Dostępne typy: ColumnClustered, Line, Pie, Bar, Area, XYScatter.
4.  **Czyszczenie Danych**: Analizuj dane pod kątem problemów (puste wiersze/komórki, spacje, mieszane typy). Jeśli znajdziesz problemy, odpowiedz **tylko i wyłącznie** akcją [ACTION:REPLACE_DATA:dane_jako_tablica_JSON].
5.  **Anomalie**: Identyfikuj wartości odstające w danych liczbowych i przedstaw je w raporcie markdown.
6.  **Ogólne**: Zawsze formatuj formuły i kod w blokach markdown. Odpowiadaj profesjonalnie, zwięźle i po polsku.`}]},{role:"model",parts:[{text:"Rozumiem. Jestem Felix-AI 2.0. Gotowy do zaawansowanej pomocy w Excelu."}]}]}async function v(e){if(h.startsWith("AIzaSy"))throw new Error("Klucz API nie został ustawiony w pliku taskpane.js. Wklej swój klucz, aby aplikacja działała.");const o=await fetch(j,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:e,generationConfig:{temperature:.4,topP:.95}})});if(!o.ok){const n=await o.json();throw new Error(n.error?.message||`Błąd serwera API (${o.status})`)}const t=await o.json();return!t.candidates||t.candidates.length===0||!t.candidates[0].content?"Przepraszam, model nie wygenerował odpowiedzi. Spróbuj zadać pytanie inaczej.":t.candidates[0].content.parts[0].text}function E(e){const a=e.match(/\[ACTION:(\w+):([\s\S]+?)\]/);if(a){const o=e.replace(a[0],"").trim();let t=a[2].trim();if(a[1]==="REPLACE_DATA")try{t=JSON.parse(t)}catch(n){return console.error("Błąd parsowania JSON w akcji REPLACE_DATA:",n),{cleanText:e,action:null}}return{cleanText:o,action:{type:a[1],payload:t}}}return{cleanText:e,action:null}}async function z(e,a){await Excel.run(async o=>{switch(e){case"CREATE_CHART":{const t=o.workbook.getSelectedRange();o.workbook.worksheets.getActiveWorksheet().charts.add(a,t,"Auto");break}case"INSERT_FORMULA":{const t=o.workbook.getActiveCell();t.formulas=[[a]];break}case"REPLACE_DATA":{const t=o.workbook.getSelectedRange();t.values=a;break}}await o.sync()}).catch(o=>{console.error("Błąd wykonania akcji w Excelu:",o),d("ai",`Wystąpił błąd podczas wykonywania akcji w Excelu: ${o.message}`)})}async function I(){try{return await Excel.run(async e=>{const a=e.workbook.getSelectedRange();return a.load(["values","cellCount"]),await e.sync(),a.cellCount>p?{error:`Zaznaczono więcej niż ${p} komórek. Zmniejsz zaznaczenie.`}:{data:a.values}})}catch(e){return console.error("Błąd pobierania danych z Excela:",e),{error:"Nie udało się pobrać danych. Upewnij się, że komórki są zaznaczone w arkuszu."}}}async function b(e,a=null){let o,t=[...l],n=!!a;if(n){const s=await I();if(s.error)throw new Error(s.error);o=`Kontekst z zaznaczonych komórek: ${JSON.stringify(s.data)}. Zadanie: ${a}`,t.push({role:"user",parts:[{text:o}]})}else o=e,d("user",e),t.push({role:"user",parts:[{text:o}]});const i=await v(t),{cleanText:r,action:c}=E(i);if(c){await z(c.type,c.payload);const s=`Wykonałem akcję: ${c.type}.`;n?m(marked.parse(s)):(d("ai",r||s),f(e,r||s))}else n?m(marked.parse(r)):(d("ai",r),f(e,r))}async function S(e){e.preventDefault();const a=document.getElementById("prompt-input"),o=document.getElementById("send-button"),t=a.value.trim();if(!(!t||o.disabled)){o.disabled=!0,a.value="",a.style.height="auto",y(!0);try{await b(t,null)}catch(n){d("ai",`Przepraszam, wystąpił błąd: ${n.message}`)}finally{y(!1),o.disabled=!1,a.focus()}}}async function T(e){const o=e.currentTarget.dataset.prompt,t=document.querySelectorAll(".action-button");t.forEach(n=>n.disabled=!0),m('<div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; gap: 10px;"><div class="spinner"></div><span>Pracuję nad tym...</span></div>');try{await b("",o)}catch(n){m(`<p style="color: #ff5c5c;">Błąd: ${n.message}</p>`)}finally{t.forEach(n=>n.disabled=!1)}}function L(){const e=localStorage.getItem("felix-ai-history");e?l=JSON.parse(e):l=k()}function f(e,a){l.push({role:"user",parts:[{text:e}]}),l.push({role:"model",parts:[{text:a}]}),localStorage.setItem("felix-ai-history",JSON.stringify(l))}function O(){confirm("Czy na pewno chcesz wyczyścić całą historię czatu? Tej operacji nie można cofnąć.")&&(l=k(),localStorage.removeItem("felix-ai-history"),w(),d("ai","Historia została wyczyszczona. Możemy zacząć od nowa!"))}function R(){const e=l.slice(2).map(n=>`${n.role==="user"?"Użytkownik":"Felix-AI"}:
${n.parts[0].text}
`).join(`
---
`),a=new Blob([e],{type:"text/plain;charset=utf-8"}),o=URL.createObjectURL(a),t=document.createElement("a");t.href=o,t.download=`felix-ai-chat-history-${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(o)}
