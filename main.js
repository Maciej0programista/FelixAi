(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function a(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(n){if(n.ep)return;n.ep=!0;const r=a(n);fetch(n.href,r)}})();function g(){const o=document.getElementById("theme-toggle");(localStorage.getItem("felix-ai-theme")||"light")==="dark"&&(document.body.classList.add("dark-mode"),o.checked=!0),o.addEventListener("change",()=>{document.body.classList.toggle("dark-mode",o.checked),localStorage.setItem("felix-ai-theme",o.checked?"dark":"light")});const a=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");a.forEach(n=>{n.addEventListener("click",()=>{a.forEach(r=>r.classList.remove("active")),n.classList.add("active"),t.forEach(r=>r.classList.toggle("active",r.id===n.dataset.tab))})})}function h(o){const e=document.getElementById("chat-window");e.innerHTML="",o.slice(1).forEach(a=>d(a.role==="model"?"ai":"user",a.parts[0].text))}function d(o,e){const a=document.getElementById("chat-window"),t=document.createElement("div");t.classList.add("message",`${o}-message`);const n=document.createElement("div");if(n.classList.add("message-content"),o==="ai"){const r=document.createElement("span");r.className="material-symbols-outlined avatar",r.textContent="smart_toy",t.appendChild(r),n.innerHTML=marked.parse(e||"...")}else n.textContent=e;t.appendChild(n),a.appendChild(t),o==="ai"&&f(t),a.scrollTop=a.scrollHeight}function f(o){o.querySelectorAll("pre").forEach(e=>{const a=e.querySelector("code");if(!a||(hljs.highlightElement(a),e.querySelector(".copy-button")))return;const t=document.createElement("button");t.className="copy-button",t.textContent="Kopiuj",t.onclick=()=>{navigator.clipboard.writeText(a.textContent).then(()=>{t.textContent="Skopiowano!",setTimeout(()=>{t.textContent="Kopiuj"},2e3)})},e.appendChild(t)})}function y(o){document.getElementById("typing-indicator").classList.toggle("hidden",!o)}function m(o){const e=document.getElementById("analysis-results");e.innerHTML=o,f(e)}const w="gemma-3-27b-it",k="AIzaSyDdiiErxw-D8FRxk0VN38NkSAZkmj6iWgU",z=`https://generativelanguage.googleapis.com/v1beta/models/${w}:generateContent?key=${k}`;function E(){return[{role:"user",parts:[{text:`Jesteś 'Felix-AI', ekspertem od Microsoft Excel. Twoje zadania:
    1.  Generuj i tłumacz formuły Excela (używaj polskich nazw funkcji jak SUMA, JEŻELI, I).
    2.  Analizuj dane (do 100 komórek) i twórz zwięzłe podsumowania w punktach.
    3.  Sugeruj typy wykresów. Użyj formatu: [ACTION:CREATE_CHART:TypWykresu], gdzie TypWykresu to jeden z: ColumnClustered, Line, Pie, XYScatter. Nie dodawaj innego tekstu.
    4.  Tłumacz nagłówki na angielski. Zwróć tylko przetłumaczone słowa oddzielone przecinkami.
    5.  Zawsze formatuj formuły i kod w blokach markdown. Odpowiadaj profesjonalnie i zwięźle.`}]},{role:"model",parts:[{text:"Rozumiem. Jestem Felix-AI, gotowy do pomocy w Excelu."}]}]}async function b(o){const a=await fetch(z,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:o,generationConfig:{temperature:.3,topP:.95}})});if(!a.ok){const n=await a.json();throw new Error(n.error?.message||`Błąd serwera API (${a.status})`)}const t=await a.json();return!t.candidates||t.candidates.length===0?"Przepraszam, model nie wygenerował odpowiedzi. Spróbuj ponownie.":t.candidates[0].content.parts[0].text}function x(o){const e=o.match(/\[ACTION:(\w+):(.+?)\]/);return e?{type:e[1].trim(),payload:e[2].trim()}:null}async function v(o,e){o==="CREATE_CHART"&&await Excel.run(async a=>{const t=a.workbook.getSelectedRange();a.workbook.worksheets.getActiveWorksheet().charts.add(e,t,"Auto"),await a.sync()})}async function C(){try{return await Excel.run(async o=>{const e=o.workbook.getSelectedRange();return e.load(["values","cellCount"]),await o.sync(),e.cellCount>100?{error:"Zaznaczono więcej niż 100 komórek. Zmniejsz zaznaczenie."}:{data:e.values}})}catch{return{error:"Nie udało się pobrać danych. Upewnij się, że komórki są zaznaczone w arkuszu."}}}async function p(o,e,a=null){let t,n=[...e];if(a){const i=await C();if(i.error)throw new Error(i.error);t=`Kontekst z zaznaczonych komórek: ${JSON.stringify(i.data)}. Zadanie: ${a}`,n=[e[0],{role:"user",parts:[{text:t}]}]}else t=o,n.push({role:"user",parts:[{text:t}]});const r=await b(n),s=x(r);if(s){await v(s.type,s.payload);const i=`Wykonałem akcję: Stworzyłem wykres typu '${s.payload}'.`;return{text:i,historyEntry:{role:"model",parts:[{text:i}]}}}return{text:r,historyEntry:{role:"model",parts:[{text:r}]}}}Office.onReady(async o=>{if(o.host!==Office.HostType.Excel)return;g();let e=JSON.parse(localStorage.getItem("felix-ai-history"))||E();h(e);const a=document.getElementById("chat-form"),t=document.getElementById("prompt-input"),n=document.getElementById("send-button");a.addEventListener("submit",async s=>{s.preventDefault();const i=t.value.trim();if(!i||n.disabled)return;n.disabled=!0,t.value="",t.style.height="auto",d("user",i);const u=[...e,{role:"user",parts:[{text:i}]}];y(!0);try{const c=await p(i,u);d("ai",c.text),e.push({role:"user",parts:[{text:i}]}),e.push(c.historyEntry),localStorage.setItem("felix-ai-history",JSON.stringify(e))}catch(c){d("ai",`Przepraszam, wystąpił błąd: ${c.message}`)}finally{y(!1),n.disabled=!1}}),t.addEventListener("input",()=>{t.style.height="auto",t.style.height=t.scrollHeight+"px"}),t.addEventListener("keydown",s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),a.requestSubmit())});const r=(s,i)=>{document.getElementById(s).addEventListener("click",async u=>{u.currentTarget;const c=document.querySelectorAll(".action-button");c.forEach(l=>l.disabled=!0),m('<div id="typing-indicator"><div class="typing-dots"><span></span><span></span><span></span></div><span>Pracuję nad tym...</span></div>');try{const l=await p("",e,i);m(marked.parse(l.text))}catch(l){m(`<p style="color: #ff5c5c;">Błąd: ${l.message}</p>`)}finally{c.forEach(l=>l.disabled=!1)}})};r("analyze-data-btn","Wygeneruj zwięzłe podsumowanie dla tych danych w formacie markdown."),r("suggest-chart-btn","Zaproponuj najlepszy typ wykresu dla tych danych i odpowiedz tylko i wyłącznie akcją w formacie: [ACTION:CREATE_CHART:TypWykresu]."),r("translate-headers-btn","Przetłumacz nagłówki (pierwszy wiersz danych) na język angielski. Zwróć tylko przetłumaczone słowa oddzielone przecinkami, bez dodatkowego tekstu.")});
